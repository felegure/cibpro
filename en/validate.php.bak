<?php
session_start();
// $db_user = 'root';
// $db_pass = '';

//Connection à mysql et sélection de la base de données
// $connection = mysqli_connect('localhost', $db_user, $db_pass) or die(mysqli_error());
// mysqli_select_db('cibase', $connection) or die(mysqli_error());

require ("connect.php");

$connection = mysqli_connect(SERVER, USER, PASSWORD);
 if (!$connection) {
	
		echo "Sorry, the connexion to the " . SERVEUR . "failed \n";
		exit;
 } else 

 if (!mysqli_select_db($connection,BASE )) {
		echo "Sorry, Access to " .  BASE . " failed \n";
        exit;    
 } 


$user_name = $_POST['user_name'];
$password = $_POST['password']; 
$pAccess = "";

$query = "SELECT * FROM tcur_par
WHERE tcur_par_id = 'USD' 
and tcur_par_status = '1' ";
//exécution de la requête et récupération du nombre de résultats

$result = mysqli_query( $connection, $query,);
$affected_rows = mysqli_num_rows($result);

//S'il y a exactement un résultat, l'utilisateur est authentifié, sinon, on l'empêche d'entrer
if($affected_rows == 1) {
$pointeur=mysqli_fetch_object ($result); 
$_SESSION['TCURPAR'] = $pointeur->tcur_par_id;
$_SESSION['TCURVAL'] = $pointeur->tcur_par_val;
}


//Préparation de la requête
$query1 = "SELECT * FROM taccess 
WHERE taccess_user_name='$user_name' AND taccess_user_pwd='$password'
and taccess_typuser_id = 'ALL' 
and taccess_status = '1' ";
//exécution de la requête et récupération du nombre de résultats

 $result = mysqli_query( $connection,$query1);
// $result = mysqli_store_result($query1, $connection);

$affected_rows = mysqli_num_rows($result);

//S'il y a exactement un résultat, l'utilisateur est authentifié, sinon, on l'empêche d'entrer
if($affected_rows == 1) {
$pAccess='1';
$pointeur=mysqli_fetch_object ($result); 
$_SESSION['username'] = $user_name; 
$_SESSION['Access'] = $pAccess;
$_SESSION['COUNTRY'] = $pointeur->taccess_ecowas_id;
$_SESSION['STATUS'] = $pointeur->taccess_status;

require_once ("affiche_maincib_1.php"); 
}
$query2 = "SELECT * FROM taccess 
WHERE taccess_user_name='$user_name' AND taccess_user_pwd='$password'
and taccess_typuser_id = 'VIE' 
and taccess_status = '1' ";

//exécution de la requête et récupération du nombre de résultats
$result = mysqli_query($connection, $query2);
$affected_rows = mysqli_num_rows($result);

//S'il y a exactement un résultat, l'utilisateur est authentifié, sinon, on l'empêche d'entrer
if($affected_rows == 1) {
$pAccess='2';
$pointeur=mysqli_fetch_object ($result); 
$_SESSION['username'] = $user_name; 
$_SESSION['Access'] = $pAccess;
$_SESSION['COUNTRY'] = $pointeur->taccess_ecowas_id;
$_SESSION['STATUS'] = $pointeur->taccess_status;
require_once ("affiche_maincib_1.php"); 
}

$query3 = "SELECT * FROM taccess 
WHERE taccess_user_name='$user_name' AND taccess_user_pwd='$password'
and taccess_typuser_id = 'INS' 
and taccess_status = '1' ";

//exécution de la requête et récupération du nombre de résultats
$result = mysqli_query($connection,$query3);
$affected_rows = mysqli_num_rows($result);

//S'il y a exactement un résultat, l'utilisateur est authentifié, sinon, on l'empêche d'entrer
if($affected_rows == 1) {
$pAccess='3';

$pointeur=mysqli_fetch_object ($result); 

// header("Location: maincib.php?".session_name()."=".session_id());
//echo "<A HREF='maincib.htm' > Maincib </A> \n";
//On ajoute l'utilisateur aux variables de session
$_SESSION['username'] = $user_name; 
$_SESSION['Access'] = $pAccess;
// define ('COUNTRY', $pointeur->taccess_ecowas_id);
//define ('STATUS', $pointeur->taccess_status);
$_SESSION['COUNTRY'] = $pointeur->taccess_ecowas_id;
$_SESSION['STATUS'] = $pointeur->taccess_status;
// echo 'user name=$user_name';

// define ('COUNTRY', $pointeur->taccess_ecowas_id);
// define ('STATUS', $pointeur->taccess_status);
// echo " var de COUNTRY:{$_SESSION['COUNTRY']}";
// echo " var de STATUS:{$_SESSION['STATUS']}";
// echo " var de username:{$_SESSION['username']}";
// echo " var de Access: {$_SESSION['Access']}";
require_once ("affiche_maincib_1.php"); 
}

$query4 = "SELECT * FROM taccess 
WHERE taccess_user_name='$user_name' AND taccess_user_pwd='$password'
and taccess_typuser_id = 'VAL' 
and taccess_status = '1' ";
//exécution de la requête et récupération du nombre de résultats
$result = mysqli_query($connection, $query4);
$affected_rows = mysqli_num_rows($result);

//S'il y a exactement un résultat, l'utilisateur est authentifié, sinon, on l'empêche d'entrer
if($affected_rows == 1) {
$pAccess='4';

$pointeur=mysqli_fetch_object ($result); 

$_SESSION['username'] = $user_name; 
$_SESSION['Access'] = $pAccess;
$_SESSION['COUNTRY'] = $pointeur->taccess_ecowas_id;
$_SESSION['ROWID']=1000;
// echo 'user name=$user_name';
// echo "STATUS=$pointeur->taccess_status";
// echo "STATUS=STATUS";
// echo "PAYS=$pointeur->taccess_ecowas_id";
// echo "USERNAME=$user_name";
require_once ("affiche_maincib_1.php"); 
}
// header("Location: maincib.php?".session_name()."=".session_id());
//echo "<A HREF='maincib.htm' > Maincib </A> \n";
//On ajoute l'utilisateur aux variables de session
//Préparation de la requête

$query5 = "SELECT * FROM taccess 
WHERE taccess_user_name='$user_name' AND taccess_user_pwd='$password'
and taccess_typuser_id = 'ADM' 
and taccess_status = '1' ";
 
//exécution de la requête et récupération du nombre de résultats
$result = mysqli_query($connection, $query5);
$affected_rows = mysqli_num_rows($result);

//S'il y a exactement un résultat, l'utilisateur est authentifié, sinon, on l'empêche d'entrer
if($affected_rows == 1) {
$pAccess='5';
$pointeur=mysqli_fetch_object ($result); 
$_SESSION['username'] = $user_name; 
$_SESSION['Access'] = $pAccess;
$_SESSION['COUNTRY'] = $pointeur->taccess_ecowas_id;
$_SESSION['STATUS'] = $pointeur->taccess_status;
$_SESSION['NOMSESSION'] = session_name();
require_once ("affiche_maincib_1.php");
}

if ($pAccess == '' ) {
$_SESSION['ERROR_MSG'] = "Access Forbiden  - Please check your user name & password";
echo "<script language='JavaScript'>alert('Please check your user name and password !' )</script>"; 
require_once ("access.php");
exit;
}
?>